<h1>SOAR EDR Project | Intro</h1>

<p align="center">
<img src="https://snipboard.io/6rb2ue.jpg" height="80%" width="80%" alt="Disk Sanitization Steps"/>
<h2>Description</h2>
<br />
<p align="center">
welcome to part three of five for the series on the sore EDR project if you haven't seen the previous Parts where we go over how to build out a workflow for this project and set up lima charlie on our machines I would highly recommend you go and watch that first today our objective is to generate Telemetry related to lasagna which is the password recovery tool that we'll be using and create a detection and response rule in Lima Charlie to detect this activity so then we can send it over to times for automation let's get started to begin head over to lasagna's GitHub and I'll leave all of the links Down Below in the description for you what we want to do is click on the releases and we'll click on lasagna. exe and now that I realized we need to disable our Windows security so let's go ahead and search up Windows security and I'll go ahead and select the virus and threat protection click on manage disable realtime protection now if I take a look at the downloads it says lasagna was blocked as unsafe by Microsoft Defender smart screen whenever you see this it's doing its job but what we can do is click on the three dots and click on keep and it says this app is unsafe that's okay let's keep it anyways and we got this here so now what we can do is take a look at the downloads and let's open up a Powershell so I'll hold shift and right click and click on open Powershell window here just to make sure it works I'll just type in lasagna and it works awesome and because I ran this lima charlie should also pick up the process for lasagna so let's head over to Lima Charlie and take a look so let's head over to sensors list and click on the sensor and from here scroll down we want to select timeline now we executed this not even a minute ago so it should be somewhere here or what we can do is type in lasagna taking a look at the earliest event we do see it at 205 2 generating an event of newcore documents and we do see the path as C users administrator downloads we got our hash as well and the process ID but what we're interested in the most is the new process event so let's go ahead and click on that and on the right we get all of this juicy information here we have the command line is the file signed yes or no we have the file path the hash the parent so we have Powershell here we have the file path of the parent process and the username we got our process ID pretty good information to have to start generating our detection Rule now how dowe do this well first and foremost let's go ahead and open up a new tab for Lima Charlie and I'll head over to our organization and from here we want to select Automation and DNR rules on the top right we do have a new rule that we can use so I'll click on new rule and if this is your first time building a rule this might look pretty intimidating but don't worry I'll show you a hack that you can use going forward now we don't need to build a rule from scratch I mean there's a lot of different formats and all that stuff so what we can do instead is go back and let's just search up a rule that is similar to ours we know that lasagna is a credential access tool so I'll type in credential and hey look at that we have credential dumping but let me just finish up credential and yeah so we have some of the credential stuff let's take a look at all the available ones here what we're most interested in is the process creation now you might say how do I know that well if we go back over to the events take a look at the event type it is set to new process so these are all process Creations so if I head back over to the DNR rules we do see a Windows process creation so let's go ahead and click on that and at the bottom we do see view the content of this rule in the GitHub repository so I'll click on that there you go here's the rule right here so what we can do is go ahead and click on Raw copy this head back into our Rule and click on the pencil icon now we can go ahead and paste in what we just copied now if you take a look at the top we do see a detect and we do see a respond so this essentially signifies the two blocks here starting from respond I'll just select all of this and cut it and then I'll paste it inside the respond block now we don't actually need the respond here so I'll just go ahead and remove it remember that respond is just telling us that hey this is the response portion similar to detect we don't need it we'll remove it and expand this there you go starting from the beginning we do see events with new process and existing process so what does that mean well let's head back over to our lasan events here what we want to do is Select event collection and from here is just simply grabbing these event types so if I search up process we see existing process and if we scroll down we also see new process as well so this section is essentially saying this detection will only trigger if the event is under the new process or existing process event type now we get our first operator and this is the operator of and so what does that mean well it means the event type must be either new process or existing process and the and is specified by this operator to get a list of operators they actually provide some right here so operator reference there's Andor is exists contains starts with ends with it's greater than and just many others so I'll go back over to expand and again the operator being used here is and and currently this is what it's doing in plain English so let's remove this and then let's continue or says and rules okay now the rules is going to be the criteria so meaning you must follow these rules the operator is Windows K sensitive is false and it ends with so it's using two different operators is and ends with where the path is event file path and you might be like where did they get that well heading back over to our sensor let's go back to our timeline and search for our lasagna process clicking on the new process because we're interested in the new or existing process so I'll click on that and we do see a file path here going back over to the detection and response rule we see the event file path event file path looking here event file path the event has a nested field of file path so that is why we have event and file path for example let's just say I am interested in the hash then what will I do well I'll type in event slash just like that or 1 H so just like this I'll keep it as file path I believe it was underscore let me just double check file underscore path yes it is where the value ends in device credential deployment. exe so let's bring back to plain English here what the heck does this mean well essentially it is the event type must be either new process or existing process and must be a Windows machine we can ignore case sensitivity and the file path must end with Device credential deployment. exe now if we wanted to detect our process of lasagna we can simply replace device credential deployment with lasagna and in theory that should technically work so let's go ahead and do that I'll remove the device credential deployment and I'll say lasagna now if we take a look at our events we can see that the file path ends with lasagna here but notice how the Zed is capitalized that is why we have the case sensitive as false so regardless even if our value has a lowercase Zed or in this case a capital Z we should still be okay so I'll keep this as that but let's go ahead and add some more options because if you recall let me head back over to my server here take a look at the flags that are available for lasagna we have all browsers chat database games git Mals Maven a lot of others so let's just say all ooh look at that we got some passwords here now what we can do is head back over to the ma Charlie I'll save this for now let's go over here we'll refresh this and we'll wait a bit until the process is generated so after a couple seconds we do get our new process that occurred and I'll click on this one here I'll just zoom out just a bit it's a lot easier to see it like this and yeah so I selected the first new process for our lasagna that occurred and actually this is the new process here okay so yeah so taking a look at our file path we do see lasagna. exe at the end but if you take a look at the command line here we do see an all this time if we look at the previous process for the command line we just see it as lasagna. exe we don't see any command line arguments associated with it now let's add on to our detection rule to include this command line argument so the new rule that I want to create is that the event type must be either new process or existing process and it must be windows and the file path ends with lasagna. exe or the command line ends with all or the command line contains lasagna or hash equals the lasagna's hash now I do foresee some false positives for the command line that ends with all I mean for example we have an IP config /all that's going to trigger that but but for this demo let's just keep it as is so how do we build this out currently we have this section good to go so this is good right because we have the new process the existing  process and it is Windows right here so what do we do how do we create the other ones well we must include a operation of or and then I'll press tab so our new rules is going to be living under this particular or so these rules will be K sensitive equals false because I don't want any of that and I'll have the operator so right here we want that the file path ends with lasagna. exe so I have the operator as ends withd and then the path is going to be file path so we'll type in event SL file path and finally the value itself is going to end in lasagna so I can type this any way I want because I am ignoring case sensitivity so I'll say value lasagna. exe awesome so we satisfied this criteria so this one is good file path ends with lasagna now we got to take a look at the command line and taking alook at this before I move on I need to make this operator align with our case sensitive so I'll do that do that and do that perfect the way you can tell it's kind of hard to see but I'll just try and draw it out here there's a line right there so this linK will tell you what your fields are under if that makes sense and I want all of my stuff to be under the case I don't know why this looks weird there you go so the second one I'm going to say Dash case sensitive false and then just like before Ops ends with and the path is going to be event SL command line now why is it command line well let's go back over to our processes and we see that the command line is this right here it's using the commandor line as a field and we're interested in particularly this command line argument of all so that's why we see an ends with command line and the value is going to be all beautiful and so that means that this one is now good let me start erasing some of these so it's a lot easier to see there you go that looks pretty good what's next command line contains lasagna okay let's do that so I'll put a dash case sensitive is false press tab Ops contains so this time I am using the operator of contains and I'll say the path is the event SLC command line the value is lasagna so this one is good now the last one is our hash so let's do our hash now I don't need this anymore which is the previous rule that we modified so I'll just remove that and I'll just keep on building on this one here so I'll type in case sensitive is false and I'll type in operator is the reason why I say is is because I want this to be equal to and then I'll type in path event forward slash and let's see where this hash is located this hash Has a Field name of hash so I'll use that and I'll copy the field value right here so the event is Slash and the value I'm going to put it in a single quote is going to be this hash right here so essentially that is now our rule the event type must be either new process or existing process and must be windows so that is good the file path if we take a look here the file path must end with lasagna so we have the operator as ends with lasagna okay and then the command line must end with all so if we take a look at our second one we have the operator as ends with where the command line is set to all so that is good and then we have command line contains lasagna looking at the third one which is this we see our case sensitive as false operator is contains the path is command line and the value is lasagna finally we have our hash equals the lasagna hash so we take a look at the case sensitive that is false the operator is now is because we want this to be equal to and the path is event slash and the value is the hash of the lasagna file now again it is very difficult to see but there's a line right here there's a line right here line here and a line here so it has four criterias to meet within this one particular or operator and again there's a big line right here that signifies that this particular or this one right here is using the rules to meet its criteria so I'll go ahead and remove everything else at the bottom and let's go ahead and click on restore now we can move on to the respond block I wonder if I can expand the respond no I cannot that's okay so the action is currently set to report if you want a list of actions you can look at their documentation but essentially what report does is that if a certain event meets this criteria for this detection it will then generate a detection under the following detection Tab and that is what we want so we want this as a report the metadata I'm going to have it as author and let's just say my dfir the
description detects lasagna and then just bracket sord DED sword no sword dedr tool false positives uh let's just say to the Moon level mediums fine reference I don't have a reference so I'll remove that the tags it is going to be credential access I'm just going to remove the technique ID here and the name I'm going to say my dfir Das Haack tool Das lasagna and then bracket s- EDR beautiful I think this looks pretty good so let's go ahead and save the rule I'm going to call this as my defer Das lasagna Das s- EDR there you go I'm going to save this out and our new rule is created so what I really love about lima charlie here is that it has the capability to actually test your rule and how do you test it well click on target event and we just need to paste in the event to test it so let's go back over to our event here and I'll go ahead and just copy the entire event and let's paste it in now from here if I scroll down we can click on test event and nice look at that four operations were evaluated with the following results true true true true all green looking good just to quickly pause and recap what the heck I just did I didn't build the rule from scratch I mean I kind of did later on but what I did in the beginning was using existing rule found here in the GitHub and essentially I just built on that if you're starting out or in fact even if you're Advanced you should take a look at an existing Rule and then modify that to fit your use case in my opinion it's a lot easier to follow and alter an existing rule then start from scratch because by following an existing rule you can follow its format and take a look at what field names that they're using so again highly recommend you take a look at the GitHub look at existing Str rules copy it and then alter it to fit your use case and now all we really need to do is start generating this so I'm going to actually go back to the homepage here by clicking on the LC icon go into the organization and let's select detections so we have a lot of detections here and I am going to delete them all this cannot be undone yes that is okay now we have a clean slate I'm going to head back over to my server and let's clear out the screen here let's go ahead and run lasagna space all in theory our detection should catch this so lasagna runs over to our lima charlie there's no detections yet we'll just refresh it and still no detections but while we wait for the rule to be generated I released the my dfir sock analyst course which contains over 30 plus Hands-On labs and five exclusive sock projects if you or someone you know is interested in particularly the security operations domain this course is designed to help students learn how to ask better questions and investigate Network endpoint mare identity and Cloud related Telemetry once you purchase it it is yours for life and updates are free I'll put this in the description if you're interested and after refreshing the detections we do see a couple detections here at the very bottom we have the my df- hack tool Das lasagna that is awesome I'll go ahead and click on that and here's our event we have our command line lasagna all we have the file path we got the hash we have our host name the external IP address o and we also have our link so what I'm doing here is taking a look at the available Fields within this detection so then I can use it in the Playbook or story when we build it in time and before I forget I'll copy this Rule and you can find it in the description down below that way if you have some problems with your formatting you can go ahead and just copy mine I hope that everything went smoothly for you creating a detection rule in Lima Charlie can be a little bit confusing especially if you have never created a rule before but just like anything else the more reps you do the better you'll become at it and lima charlie has amazing documentation that you can reference anytime you get stuck as a reminder links to my S course and the rule file will be in the description Down Below in part four we'll begin to set out slack and times for automation that is it for the video and I hope to see you in part four remember to stay curious and do things differently
